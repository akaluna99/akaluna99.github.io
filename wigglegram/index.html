<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Luna's wigglegram - Upload photo taken by a stereographic camera, and create GIF's">
    <meta name="keywords" content="wigglegram, stereographic camera, image processing, GIF creation">
    <meta name="author" content="Luna Moreno">

    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-status-bar" content="#db4938" />
    <meta name="theme-color" content="#db4938" />
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    
    <!-- UMAMI -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="d98e84d1-2764-48aa-838a-faff60764f6b"></script>

    <title>Luna's wigglegram</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0 10px 0 10px;
background: #f7f7f7;
background: linear-gradient(180deg, rgba(247, 247, 247, 1) 0%, rgba(209, 209, 209, 1) 90%);
        }

        .drop-area {
            position: relative;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            overflow: auto;
            background-color: white;
            border: 2px dashed #ccc;
            padding: 10px;
            min-width: 25%;
            min-height: 25%;
            flex-wrap: wrap;
            max-height: 60%;
        }

        #image_base {
            max-width: 100%;
            max-height: 100%;
            display: none;
            transform: translate(0px, 0px);
        }

        .button-area {
            padding: 10px;
            display: flex;
            align-items: stretch;
            flex-direction: column;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        .button-area>* {
            margin: 5px 0;
        }

        button {
            text-align: center;
            cursor: pointer;
            font-size: 40px;
        }

        .arrow {
            position: absolute;
            padding: 0;
            text-align: center;
            padding: 5px;
            border-style: solid;
            cursor: pointer;
        }

        .arrow.left {
            left: 25px;
        }

        .arrow.right {
            right: 25px;
        }

        .arrow.up {
            top: 25px;
            left: 40%;
            right: 40%;
        }

        .arrow.down {
            bottom: 25px;
            left: 40%;
            right: 40%;
        }

        .point {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
        }

        #editedImages>img {
            cursor: crosshair;
            width: 50vw;
        }

        .loader {
            border: 16px solid #f3f3f3;
            /* Light grey */
            border-top: 16px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        blocktitle {
            flex-basis: 100%;
            text-align: center;
            padding: 10px;
        }

        .footer-bar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100vw;
            background: #222;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 0;
            font-size: 1.1em;
            z-index: 100;
        }
        .footer-bar a {
            color: #fff;
            margin: 0 12px;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        .footer-bar a:hover {
            color: #db4938;
        }
    </style>
</head>

<body onload="checkImage()">
    <h1><a href="/">Luna's</a> <a href="index.html">Wigglegram</a></h1>
    <em>Upload photo taken by a stereographic camera, then click 'Load' button</em>
    <br>
    <div class="loader" id="loaderIcon" hidden></div>
    <div id="drop-area" class="drop-area">
        <input type="file" id="drop-area-button" accept="image/*" />
        <img id="image_base" src alt="Imagen cargada">
    </div>

    <div id="editedImages" class="drop-area" style="display: none;">
        <blocktitle>For each image select the same point (ex. someone nose).
            <br>
            The effect is better if you choose something in the foreground
        </blocktitle>
    </div>

    <div id="test">

    </div>
    <div id="resultat">

    </div>

    <div id="firstButton" class="button-area">
        <label for="splits_h">Input grid H*V</label>
        <span>
            <input type="number" id="splits_h" name="splits_h" min="1" max="5" value="2">
            X
            <input type="number" id="splits_v" name="splits_v" min="1" max="5" value="2">
        </span>
        <button id="processButton" type="button" disabled>
            Load
        </button>
    </div>

    <div class="button-area">
        
        <button id="processGifButton" type="button" disabled hidden>
            Make GIF
        </button>
        <a id="downloadButton" type="button" href="" download="wigglegram.gif" disabled hidden>
            Download
        </a>
    </div>

    <!-- Footer bar -->
    <div class="footer-bar">
        <span>
            <a href="https://twitter.com/chica_botella" target="_blank" rel="noopener">Twitter</a> |
            <a href="https://www.tiktok.com/@chicabotella" target="_blank" rel="noopener">TikTok</a> |
            <a href="https://cataluna.cat" target="_blank" rel="noopener">Website</a>
        </span>
        <span style="margin-left:20px;">Made with &lt;3 by Luna Moreno</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gifshot/dist/gifshot.min.js"></script>
    <script>
        function checkImage() {
            var storedImage = localStorage.getItem('image')
            if (storedImage) {
                imageElement.src = storedImage;
                imageElement.style.display = 'block';
                processButton.disabled = false
            };
            var columnes = localStorage.getItem('columnes')
            var files = localStorage.getItem('files')
            if (columnes && files) {
                splits_h.value = columnes
                splits_v.value = files
            } else {
                splits_h.value = 2
                splits_v.value = 2
            }
        }
    </script>
    <script>
        const dropArea = document.getElementById('drop-area');
        const dropAreaButton = document.getElementById('drop-area-button');
        const imageElement = document.getElementById('image_base');
        // const overlay = document.getElementById('overlay'); // No se usa


        // Manejar el drag and drop
        dropAreaButton.addEventListener('change', (event) => {
            event.preventDefault();
            console.log(dropAreaButton.files[0])
            const files = dropAreaButton.files
            if (files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log(e)
                    imageElement.src = e.target.result;
                    imageElement.style.display = 'block';
                    localStorage.setItem('image', e.target.result);
                    processButton.disabled = false
                };
                reader.readAsDataURL(files[0]);
                localStorage.setItem('wigglegram_filename', files[0].name.split('.')[0])
            }
        })

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log(e)
                    imageElement.src = e.target.result;
                    imageElement.style.display = 'block';
                    localStorage.setItem('image', e.target.result);
                    processButton.disabled = false
                };
                reader.readAsDataURL(files[0]);
                localStorage.setItem('wigglegram_filename', files[0].name.split('.')[0])
            }
        });


        // Mover overlay con botones
        let offsetX = 0
        let offsetY = 0


        // Procesar imagen
        var gifFrames = []
        var adjustCoordinates = {}
        var columnes = 2
        var files = 2
        var resizeMult = 1
        processButton.addEventListener('click', () => {
            if (parseInt(splits_h.value) > 0 && parseInt(splits_v.value) > 0) {
                columnes = parseInt(splits_h.value)
                files = parseInt(splits_v.value)
                localStorage.setItem('columnes', columnes)
                localStorage.setItem('files', files)
            } else {
                alert('Please select a valid grid size')
                return
            }

            editedImages.style.display = null;
            dropArea.style.display = 'none';
            processButton.hidden = true;
            firstButton.style.display='none'
            processGifButton.hidden = false;

            var imgN = 0
            var colSize = imageElement.naturalWidth / columnes
            var filSize = imageElement.naturalHeight / files

            const newText = document.createElement('blocktitle')
            newText.id = 'blocktitleRemaining'
            newText.innerText = `0 of ${columnes * files}`
            editedImages.appendChild(newText)

            for (var i = 0; i < columnes; i++) {
                for (var j = 0; j < files; j++) {
                    imgN += 1
                    // Crear un canvas del tamaño del sector
                    const canvas = document.createElement('canvas');
                    canvas.width = colSize;
                    canvas.height = filSize;
                    const ctx = canvas.getContext('2d');
                    // Recortar el sector correspondiente
                    ctx.drawImage(
                        imageElement,
                        i * colSize, // sx
                        j * filSize, // sy
                        colSize,     // swidth
                        filSize,     // sheight
                        0,           // dx
                        0,           // dy
                        colSize,     // dwidth
                        filSize      // dheight
                    );
                    const newImg = document.createElement('img');
                    gifFrames.push(newImg)
                    newImg.src = canvas.toDataURL();
                    newImg.style.width = colSize + 'px';
                    newImg.style.height = filSize + 'px';
                    newImg.style.margin = '10px';
                    newImg.id = `image${imgN}`
                    editedImages.appendChild(newImg)
                    newImg.onclick = function () { markPoint(event, `image${imgN}`) }
                }
            }
            

            /*ctx.drawImage(imageElement, 
                0, // sx
                0, // sy
                (canvas.width/resizeMult)/2, // swidth
                (canvas.height/resizeMult)/2, // sheight   
                0, // x
                0, // y
                canvas.width, //width
                canvas.height // height
            );
            //console.log(canvas.toDataURL())
            const newImg = document.createElement('img');
                    newImg.src = canvas.toDataURL();
                    newImg.style.maxWidth = '40%';
                    editedImages.appendChild(newImg)
            
    
            const editedImageUrl = canvas.toDataURL();
            localStorage.setItem('editedImage', editedImageUrl);*/
        });

        function markPoint(event, imageId) {
            // Obtener la posición del clic relativa a la imagen
            const img = event.target;
            const rect = img.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Crear un punto y añadirlo a la imagen
            /*const point = document.createElement('div');
            point.className = 'point';
            point.style.left = `${x}px`;
            point.style.top = `${y}px`;
            img.appendChild(point);*/

            // Guardar las coordenadas
            var conversionMut = img.naturalHeight / img.height
            adjustCoordinates[img.id] = {
                'x': x * conversionMut,
                'y': y * conversionMut
            }
            console.log(`Imagen: ${img.id}, Coordenadas: X=${x}, Y=${y}, REALES X=${x * conversionMut} , Y=${y * conversionMut}`);
            console.log(`S'han marcar ${Object.keys(adjustCoordinates).length} de ${columnes * files}`)
            blocktitleRemaining.innerText = `${Object.keys(adjustCoordinates).length} of ${columnes * files}`
            if (Object.keys(adjustCoordinates).length == columnes * files) {
                processGifButton.disabled = false;
            }
            // Aquí puedes añadir código para enviar las coordenadas al servidor o almacenarlas localmente
        }
        // Procesar imagen
        processGifButton.addEventListener('click', () => {
            dropAreaButton.hidden = true;
            processGifButton.hidden = true;
            editedImages.style.display = 'none'
            loaderIcon.hidden = false
            const gifContainer = document.createElement('div');
            gifContainer.classList.add('gif-container');
            const canvas = document.createElement('canvas');
            canvas.width = resizeMult * imageElement.naturalWidth / columnes;
            canvas.height = resizeMult * imageElement.naturalHeight / files;

            var framesRender = []
            // let n = -1; // No se usa, puedes eliminarlo
            for (var frame of gifFrames) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext("2d");
                const img = frame;
                canvas.height = img.naturalHeight
                canvas.width = img.naturalWidth
                var coordinateDifferenceX = 0
                var coordinateDifferenceY = 0
                if (frame.id != 'image1') {
                    coordinateDifferenceX = adjustCoordinates['image1'].x - adjustCoordinates[frame.id].x
                    coordinateDifferenceY = adjustCoordinates['image1'].y - adjustCoordinates[frame.id].y
                    coordinateDifferenceX /= resizeMult
                    coordinateDifferenceY /= resizeMult
                }
                console.log(`coordinateDifferenceY: ${coordinateDifferenceY}`)
                ctx.drawImage(img, coordinateDifferenceX, coordinateDifferenceY);
                const newImg = document.createElement('img');
                newImg.src = canvas.toDataURL()
                framesRender.push(newImg.src)
                // n += 1; // Eliminar si no se usa
                //test.appendChild(newImg)

                console.log(frame.id)
            }
            const ctx = canvas.getContext('2d');

            gifshot.createGIF({
                gifWidth: canvas.width,
                gifHeight: canvas.height,
                images: framesRender,
                interval: 0.15,
                numFrames: columnes * files
            }, function (obj) {
                if (!obj.error) {
                    const gifImg = document.createElement('img');
                    gifImg.src = obj.image;
                    gifImg.width = '20%';
                    gifImg.alt = `Sequence of ${columnes * files} images`;
                    imageElement.src = obj.image;

                    gifContainer.appendChild(gifImg);
                    resultat.appendChild(gifContainer);
                    dropArea.style.display = null
                    downloadButton.hidden = false
                    downloadButton.href = imageElement.src
                    downloadButton.download = `${localStorage.getItem('wigglegram_filename')}.gif`
                    loaderIcon.hidden = true

                }
            });
        })

    </script>
</body>

</html>